{% comment %}
  testimonial-carousel.liquid
  Infinite wrap-around 3-up carousel — improved so the next 3-up window
  is applied immediately on click and animation moves that window uniformly.
{% endcomment %}

<section id="testimonial-carousel-{{ section.id }}" class="testimonial-carousel-section" data-section-id="{{ section.id }}">
  <div class="carousel-inner">
    <button class="carousel-arrow carousel-arrow-left" aria-label="Previous">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M15 18l-6-6 6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
    </button>

    <div class="carousel-viewport">
      <div class="carousel-track-original" style="display:none;">
        {% for block in section.blocks %}
          <div class="carousel-card" data-index="{{ forloop.index0 }}">
            <div class="card-image">
              {% if block.settings.image != blank %}
                <img src="{{ block.settings.image | img_url: '800x' }}" alt="{{ block.settings.title | escape }}">
              {% else %}
                <img src="//placehold.co/800x450" alt="placeholder">
              {% endif %}
            </div>
            <div class="card-body">
              <p class="card-quote">{{ block.settings.quote | default: "The service was absolutely impeccable. I will come back again." }}</p>
              <p class="card-title">{{ block.settings.title | default: "Firstname L." }}</p>
              <p class="card-subtitle">{{ block.settings.role | default: "Happy customer, city" }}</p>
            </div>
          </div>
        {% endfor %}
      </div>

      <div class="carousel-track" aria-live="polite">
        {% if section.blocks.size == 0 %}
          {% for i in (1..6) %}
          <div class="carousel-card" data-index="{{ i }}">
            <div class="card-image"><img src="//placehold.co/800x450" alt="placeholder"></div>
            <div class="card-body">
              <p class="card-quote">Default testimonial placeholder.</p>
              <p class="card-title">Firstname L.</p>
              <p class="card-subtitle">Default role</p>
            </div>
          </div>
          {% endfor %}
        {% endif %}
      </div>
    </div>

    <button class="carousel-arrow carousel-arrow-right" aria-label="Next">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M9 6l6 6-6 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
    </button>
  </div>

  <style>
    #testimonial-carousel-{{ section.id }} { padding: 40px 0; --card-width: 280px; --card-height: 420px; --gap: 24px; }
    .testimonial-carousel-section .carousel-inner { display:flex; align-items:center; gap:16px; position:relative; justify-content:center; max-width:1200px; margin:0 auto; }

    .carousel-arrow { background:white; border-radius:50%; width:44px; height:44px; display:flex; align-items:center; justify-content:center; box-shadow: 0 6px 18px rgba(18,18,18,0.06); border:none; cursor:pointer; }
    .carousel-arrow[disabled] { opacity:.45; pointer-events:none; cursor:default; }
    .carousel-arrow svg { color:#222; }

    .carousel-viewport { overflow:hidden; width: calc( (var(--card-width) * 3) + (var(--gap) * 2) ); }
    .carousel-track { display:flex; gap: var(--gap); align-items:flex-start; transition: transform 420ms cubic-bezier(.2,.9,.2,1); will-change: transform; padding: 12px 0; }

    .carousel-card { width: var(--card-width); height: var(--card-height); background:#fff; border-radius:14px; box-shadow: 0 6px 16px rgba(20,20,20,0.06); overflow:hidden; display:flex; flex-direction:column; transition: transform 420ms cubic-bezier(.2,.9,.2,1), box-shadow 420ms; transform-origin:center bottom; flex-shrink:0; }

    .card-image { flex:0 0 48%; background:#f5f5f5; display:flex; align-items:center; justify-content:center; overflow:hidden; }
    .card-image img { width:100%; height:100%; object-fit:cover; display:block; }

    .card-body { flex:1; padding:20px; display:flex; flex-direction:column; justify-content:center; text-align:center; gap:10px; }
    .card-quote { font-size:14px; line-height:1.45; color:#222; margin:0 12px; min-height:56px; }
    .card-title { font-weight:700; margin-top:8px; font-size:14px; }
    .card-subtitle { font-size:12px; color:#777; margin-top:4px; }

    .carousel-card.center { transform: scale(1.08); box-shadow: 0 20px 40px rgba(18,18,18,0.12); z-index:3; }
    .carousel-card.side { transform: scale(0.98); z-index:2; opacity:0.98; }
    .carousel-card.hidden { transform: scale(0.92); opacity:0.35; filter: blur(.2px); z-index:1; }

    @media (max-width:900px) { #testimonial-carousel-{{ section.id }} { --card-width: 240px; --card-height:380px; } .carousel-viewport { width: calc( (var(--card-width) * 3) + (var(--gap) * 2) ); } }
    @media (max-width:640px) { #testimonial-carousel-{{ section.id }} { padding:24px 0; --card-width:200px; --card-height:340px; } .carousel-arrow { display:none; } .carousel-viewport { width:100%; } .carousel-track { padding:6px; } }
  </style>

  <script>
    (function(){
      const root = document.getElementById('testimonial-carousel-{{ section.id }}');
      if (!root) return;
      const originalContainer = root.querySelector('.carousel-track-original');
      const track = root.querySelector('.carousel-track');
      const leftBtn = root.querySelector('.carousel-arrow-left');
      const rightBtn = root.querySelector('.carousel-arrow-right');

      // gather original cards (either from originalContainer or existing track)
      let originals = Array.from(originalContainer && originalContainer.children && originalContainer.children.length ? originalContainer.children : root.querySelectorAll('.carousel-track > .carousel-card'));
      if (!originals.length) originals = Array.from(track.children);

      const total = originals.length;
      if (total === 0) return;
      const cloneCount = Math.min(3, total); // number of clones on each side
      let isTransitioning = false;

      function cloneNodeSimple(node) {
        const clone = node.cloneNode(true);
        clone.classList.add('clone');
        return clone;
      }

      function buildTrack() {
        track.innerHTML = '';
        // append last clones
        for (let i = total - cloneCount; i < total; i++) {
          const n = cloneNodeSimple(originals[i % total]);
          track.appendChild(n);
        }
        // append originals (clone them so originals list remains unmodified)
        originals.forEach(n => track.appendChild(n.cloneNode(true)));
        // append first clones
        for (let i = 0; i < cloneCount; i++) {
          const n = cloneNodeSimple(originals[i]);
          track.appendChild(n);
        }
      }

      buildTrack();

      let positionIndex = cloneCount; // left-most visible card in built track
      let builtCount = track.children.length;

      function getGap() {
        const cs = getComputedStyle(track);
        return parseFloat(cs.gap || '24') || 24;
      }
      function fullCardWidth() {
        const card = track.children[0];
        if (!card) return 0;
        const w = card.getBoundingClientRect().width;
        return w + getGap();
      }

      // set transform based on a given positionIndex
      function setTransformTo(index, animate = true) {
        const full = fullCardWidth();
        const offset = - (index * full);
        if (!animate) track.style.transition = 'none';
        else track.style.transition = '';
        track.style.transform = `translateX(${offset}px)`;
        if (!animate) void track.offsetHeight;
      }

      // update visible classes using a given left-most built index (so we can apply upcoming window immediately)
      function updateVisualClassesFor(leftMostBuiltIndex) {
        const children = Array.from(track.children);
        children.forEach((c, i) => {
          c.classList.remove('center','side','hidden');
          if (i >= leftMostBuiltIndex && i <= leftMostBuiltIndex + 2) {
            if (i === leftMostBuiltIndex + 1) c.classList.add('center');
            else c.classList.add('side');
          } else {
            c.classList.add('hidden');
          }
        });
      }

      // wrapper that updates classes for current positionIndex
      function updateVisualClasses() {
        updateVisualClassesFor(positionIndex);
      }

      // navigation (applies new classes first, then animates)
      function goToBuiltIndex(targetIndex) {
        if (isTransitioning) return;
        isTransitioning = true;
        // apply classes for the target window immediately
        updateVisualClassesFor(targetIndex);
        // disable buttons
        if (leftBtn) leftBtn.disabled = true;
        if (rightBtn) rightBtn.disabled = true;
        // animate to the target
        positionIndex = targetIndex;
        setTransformTo(positionIndex, true);
      }

      function next() { goToBuiltIndex(positionIndex + 1); }
      function prev() { goToBuiltIndex(positionIndex - 1); }

      // after animation ends, if we're in clone zone teleport without animation
      track.addEventListener('transitionend', function() {
        isTransitioning = false;
        builtCount = track.children.length;
        // teleport if moved into first-clones (right side beyond originals)
        if (positionIndex >= cloneCount + total) {
          positionIndex = positionIndex - total;
          setTransformTo(positionIndex, false);
          updateVisualClasses(); // reflect correct classes after teleport
        }
        // teleport if moved into last-clones (left side before originals)
        if (positionIndex < cloneCount) {
          positionIndex = positionIndex + total;
          setTransformTo(positionIndex, false);
          updateVisualClasses();
        }
        // re-enable buttons
        if (leftBtn) leftBtn.disabled = false;
        if (rightBtn) rightBtn.disabled = false;
      });

      // initial placement & classes
      setTimeout(()=> {
        builtCount = track.children.length;
        positionIndex = cloneCount;
        setTransformTo(positionIndex, false);
        updateVisualClasses();
      }, 30);

      // attach controls
      rightBtn && rightBtn.addEventListener('click', next);
      leftBtn && leftBtn.addEventListener('click', prev);

      // keyboard
      root.tabIndex = 0;
      root.addEventListener('keydown', function(e) {
        if (e.key === 'ArrowLeft') prev();
        if (e.key === 'ArrowRight') next();
      });

      // swipe support
      let startX = 0, isTouching = false;
      root.addEventListener('touchstart', (e) => { isTouching = true; startX = e.touches[0].clientX; }, {passive:true});
      root.addEventListener('touchend', (e) => {
        if (!isTouching || isTransitioning) return;
        const endX = (e.changedTouches && e.changedTouches[0] && e.changedTouches[0].clientX) || startX;
        const dx = endX - startX;
        if (Math.abs(dx) > 30) {
          if (dx < 0) next(); else prev();
        }
        isTouching = false;
      }, {passive:true});

      // responsive: recompute on resize and restore without animation
      let resizeTimer;
      window.addEventListener('resize', function(){
        clearTimeout(resizeTimer);
        resizeTimer = setTimeout(function(){ setTransformTo(positionIndex, false); }, 120);
      });

    })();
  </script>

  {% schema %}
  {
    "name": "Testimonials Carousel",
    "settings": [],
    "blocks": [
      {
        "type": "card",
        "name": "Testimonial card",
        "settings": [
          { "type": "image_picker", "id": "image", "label": "Image" },
          { "type": "text", "id": "title", "label": "Name", "default": "Firstname L." },
          { "type": "text", "id": "role", "label": "Role / Location", "default": "Happy customer, City" },
          { "type": "textarea", "id": "quote", "label": "Quote", "default": "The service was absolutely impeccable. I will come back again!" }
        ]
      }
    ],
    "max_blocks": 6,
    "presets": [
      {
        "name": "Testimonials carousel",
        "category": "Testimonials",
        "blocks": [
          { "type": "card", "settings": { "title":"Alex R.","role":"Seattle, WA","quote":"Amazing experience, couldn't recommend more.","image":"" } },
          { "type": "card", "settings": { "title":"Priya S.","role":"Lahore, PK","quote":"Exceptional service and friendly staff.","image":"" } },
          { "type": "card", "settings": { "title":"Marcus T.","role":"Berlin, DE","quote":"Top notch quality and fast delivery.","image":"" } },
          { "type": "card", "settings": { "title":"Rita K.","role":"NYC, USA","quote":"We come here every season — superb.","image":"" } },
          { "type": "card", "settings": { "title":"Omar N.","role":"Dubai","quote":"They went above and beyond.","image":"" } },
          { "type": "card", "settings": { "title":"Li W.","role":"Shanghai","quote":"Perfect from start to finish.","image":"" } }
        ]
      }
    ]
  }
  {% endschema %}
</section>
